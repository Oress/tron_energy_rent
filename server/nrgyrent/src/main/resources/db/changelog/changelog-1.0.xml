<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- This table stores the information about wallets themselfs pub and pri keys -->
    <changeSet id="create table nrg_managed_wallets" author="oress">
        <createTable tableName="nrg_managed_wallets">
            <column name="base58_address" type="text">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>

            <column name="private_key_enc" type="bytea" />

            <column name="created_at" type="TIMESTAMP" />
        </createTable>

        <createIndex indexName="idx_nrg_managed_wallets_base58_address"
            tableName="nrg_managed_wallets">
            <column name="base58_address" />
        </createIndex>
    </changeSet>

    <changeSet id="create table nrg_balances" author="oress">
        <createSequence sequenceName="nrg_balance_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_balances">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>
            <column name="deposit_address" type="text">
                <constraints nullable="true" />
            </column>
            <column name="manager_id" type="bigint" />
            <column name="type" type="text" defaultValue="INDIVIDUAL">
                <constraints nullable="true" />
            </column>
            <column name="label" type="text" />
            <column name="sun_balance" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="last_tx_id" type="text" />
            <column name="last_tx_timestamp" type="bigint" />

            <column name="is_active" type="boolean" />

            <column name="created_at" type="TIMESTAMP" />

            <column name="version" type="bigint" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_balances_deposit_address"
            baseTableName="nrg_balances"
            baseColumnNames="deposit_address"
            referencedTableName="nrg_managed_wallets"
            referencedColumnNames="base58_address" />

        <createIndex indexName="idx_nrg_balances_deposit_address" tableName="nrg_balances">
            <column name="deposit_address" />
        </createIndex>

        <createIndex indexName="idx_nrg_balances_manager_id" tableName="nrg_balances">
            <column name="manager_id" />
        </createIndex>
    </changeSet>

    <!-- This table stores the information about telegram users -->
    <changeSet id="create table nrg_users" author="oress">
        <createTable tableName="nrg_users">
            <column name="telegram_id" type="bigint">
                <constraints primaryKey="true" nullable="true" unique="true" />
            </column>

            <column name="telegram_username" type="text" />
            <column name="telegram_first_name" type="text" />

            <column name="role" type="text" defaultValue="user">
                <constraints nullable="false" />
            </column>

            <column name="balance_id" type="bigint" />
            <column name="group_balance_id" type="bigint" />

            <column name="disabled" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
            <column name="disabled_reason" type="text" />

            <column name="created_at" type="TIMESTAMP" />
            <column name="updated_at" type="TIMESTAMP" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_users_balance_id"
            baseTableName="nrg_users"
            baseColumnNames="balance_id"
            referencedTableName="nrg_balances"
            referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_nrg_users_group_balance_id"
            baseTableName="nrg_users"
            baseColumnNames="group_balance_id"
            referencedTableName="nrg_balances"
            onDelete="SET NULL"
            referencedColumnNames="id" />

        <createIndex indexName="idx_nrg_users_balance_id" tableName="nrg_users">
            <column name="balance_id" />
        </createIndex>

        <createIndex indexName="idx_nrg_users_group_balance_id" tableName="nrg_users">
            <column name="group_balance_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add foreign key constraint to nrg_balances" author="oress">
        <addForeignKeyConstraint constraintName="fk_nrg_balances_manager_id"
            baseTableName="nrg_balances"
            baseColumnNames="manager_id"
            referencedTableName="nrg_users"
            referencedColumnNames="telegram_id" />
    </changeSet>

    <!-- This table stores the information about user preferred wallets(i.e. where to send energy) -->
    <changeSet id="create table nrg_user_wallets" author="oress">
        <createSequence sequenceName="ngr_user_wallet_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_user_wallets">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="true" unique="true" />
            </column>

            <column name="user_id" type="bigint" />
            <column name="label" type="text" />
            <column name="address" type="text" />
            <column name="created_at" type="TIMESTAMP" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_user_wallets_user_id"
            baseTableName="nrg_user_wallets"
            baseColumnNames="user_id"
            referencedTableName="nrg_users"
            referencedColumnNames="telegram_id" />

        <createIndex indexName="idx_nrg_user_wallets_balance_id" tableName="nrg_user_wallets">
            <column name="user_id" />
        </createIndex>
    </changeSet>

    <!-- This table stores the information about orders and their state -->
    <changeSet id="create table nrg_orders" author="oress">
        <createSequence sequenceName="nrg_order_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_orders">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="true" unique="true" />
            </column>

            <column name="user_id" type="bigint" />
            <column name="balance_id" type="bigint" />
            <column name="sun_amount" type="bigint" />
            <column name="itrx_fee_sun_amount" type="bigint" />
            <column name="energy_amount" type="int" />
            <column name="receive_address" type="text" />
            <column name="duration" type="text" />
            <column name="correlation_id" type="text" />
            <column name="serial" type="text" />
            <column name="order_status" type="text" />
            <column name="itrx_status" type="int" />
            <column name="tx_id" type="text" />

            <column name="created_at" type="TIMESTAMP" />
            <column name="updated_at" type="TIMESTAMP" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_orders_user_id"
            baseTableName="nrg_orders"
            baseColumnNames="user_id"
            referencedTableName="nrg_users"
            referencedColumnNames="telegram_id" />

        <addForeignKeyConstraint constraintName="fk_nrg_orders_balance_id"
            baseTableName="nrg_orders"
            baseColumnNames="balance_id"
            referencedTableName="nrg_balances"
            referencedColumnNames="id" />

        <createIndex tableName="nrg_orders" indexName="idx_nrg_orders_user_id">
            <column name="user_id"></column>
        </createIndex>

        <createIndex tableName="nrg_orders" indexName="idx_nrg_orders_balance_id">
            <column name="balance_id"></column>
        </createIndex>

        <createIndex tableName="nrg_orders" indexName="idx_nrg_orders_correlation_id">
            <column name="correlation_id"></column>
        </createIndex>

        <createIndex tableName="nrg_orders" indexName="idx_nrg_orders_receive_address">
            <column name="receive_address"></column>
        </createIndex>
    </changeSet>

    <!-- This table stores the information about user trx withdrawals -->
    <changeSet id="create table nrg_withdrawal_orders" author="oress">
        <createSequence sequenceName="nrg_withdrawal_orders_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_withdrawal_orders">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="true" unique="true" />
            </column>

            <column name="user_id" type="bigint" />
            <column name="balance_id" type="bigint" />
            <column name="sun_amount" type="bigint" />
            <column name="fee_sun_amount" type="bigint" />
            <column name="receive_address" type="text" />
            <column name="status" type="text" />
            <column name="tx_id" type="text" />

            <column name="created_at" type="TIMESTAMP" />
            <column name="updated_at" type="TIMESTAMP" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_withdrawal_orders_user_id"
            baseTableName="nrg_withdrawal_orders"
            baseColumnNames="user_id"
            referencedTableName="nrg_users"
            referencedColumnNames="telegram_id" />

        <addForeignKeyConstraint constraintName="fk_nrg_withdrawal_orders_balance_id"
            baseTableName="nrg_withdrawal_orders"
            baseColumnNames="balance_id"
            referencedTableName="nrg_balances"
            referencedColumnNames="id" />

        <createIndex tableName="nrg_withdrawal_orders" indexName="idx_nrg_withdrawal_orders_user_id">
            <column name="user_id"></column>
        </createIndex>

        <createIndex tableName="nrg_withdrawal_orders"
            indexName="idx_nrg_withdrawal_orders_balance_id">
            <column name="balance_id"></column>
        </createIndex>
    </changeSet>

    <!-- This table stores the information about deposits -->
    <changeSet id="create table nrg_deposit_transactions" author="oress">
        <createSequence sequenceName="nrg_deposit_transactions_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_deposit_transactions">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>

            <column name="wallet_to" type="text">
                <constraints nullable="false" />
            </column>
            <column name="wallet_from" type="text">
                <constraints nullable="false" />
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tx_id" type="text">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="timestamp" type="bigint" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_deposit_transactions_wallet_to"
            baseTableName="nrg_deposit_transactions"
            baseColumnNames="wallet_to"
            referencedTableName="nrg_managed_wallets"
            referencedColumnNames="base58_address" />

        <createIndex tableName="nrg_deposit_transactions"
            indexName="idx_nrg_deposit_transactions_wallet_to">
            <column name="wallet_to"></column>
        </createIndex>
    </changeSet>

    <changeSet id="create table nrg_manual_balance_changes" author="oress">
        <createSequence sequenceName="nrg_manual_balance_changes_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_manual_balance_changes">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>
            <column name="balance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="amount_from" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="amount_to" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="changed_by" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_manual_balance_changes_balance_id"
            baseTableName="nrg_manual_balance_changes"
            baseColumnNames="balance_id"
            referencedTableName="nrg_balances"
            referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_nrg_manual_balance_changes_changed_by"
            baseTableName="nrg_manual_balance_changes"
            baseColumnNames="changed_by"
            referencedTableName="nrg_users"
            referencedColumnNames="telegram_id" />


        <createIndex indexName="idx_nrg_manual_balance_changes_balance_id"
            tableName="nrg_manual_balance_changes">
            <column name="balance_id" />
        </createIndex>

        <createIndex indexName="idx_nrg_manual_balance_changes_changed_by"
            tableName="nrg_manual_balance_changes">
            <column name="changed_by" />
        </createIndex>
    </changeSet>


    <changeSet id="create table nrg_collection_wallets" author="oress">
        <createSequence sequenceName="nrg_collection_wallets_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_collection_wallets">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>
            <column name="wallet_address" type="text">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="is_active" type="boolean" />
            <column name="deactivated_at" type="timestamp" />

            <column name="created_at" type="timestamp" />
        </createTable>

        <createIndex indexName="idx_nrg_collection_wallets_base58_address"
            tableName="nrg_collection_wallets">
            <column name="wallet_address" />
        </createIndex>
    </changeSet>

    <changeSet id="create table nrg_sweep_actions" author="oress">
        <createSequence sequenceName="nrg_sweep_actions_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="1" />

        <createTable tableName="nrg_sweep_actions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>
            <column name="collection_wallet_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="target_address" type="text">
                <constraints nullable="false" />
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tx_id" type="text">
                <constraints nullable="true" unique="true" />
            </column>
            <column name="status" type="text" defaultValue="PENDING">
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
            <column name="completed_at" type="timestamp" />
        </createTable>

        <addForeignKeyConstraint constraintName="fk_nrg_sweep_actions_collection_wallet_id"
            baseTableName="nrg_sweep_actions"
            baseColumnNames="collection_wallet_id"
            referencedTableName="nrg_collection_wallets"
            referencedColumnNames="id" />

        <createIndex indexName="idx_nrg_sweep_actions_collection_wallet_id"
            tableName="nrg_sweep_actions">
            <column name="collection_wallet_id" />
        </createIndex>
    </changeSet>

    <changeSet id="create table nrg_tariffs" author="oress">
        <createSequence sequenceName="nrg_tariffs_seq"
            dataType="bigint"
            incrementBy="1"
            startValue="2" />

        <createTable tableName="nrg_tariffs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>

            <column name="label" type="text">
                <constraints nullable="false" />
            </column>

            <column name="tx_type_1_amount_sun" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tx_type_2_amount_sun" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="is_active" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>

            <column name="is_predefined" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create default tariff" author="oress">
        <insert tableName="nrg_tariffs">
            <column name="id" valueNumeric="${defaultTariffId}" />
            <column name="label" value="${defaultTariffLabel}" />
            <column name="tx_type_1_amount_sun" valueNumeric="${txType1Amount}" />
            <column name="tx_type_2_amount_sun" valueNumeric="${txType2Amount}" />
            <column name="is_active" valueBoolean="true" />
            <column name="is_predefined" valueBoolean="true" />
            <column name="created_at" valueDate="now()" />
            <column name="updated_at" valueDate="now()" />
        </insert>
    </changeSet>

    <changeSet id="extend nrg_balances with tariff_id" author="oress">
        <addColumn tableName="nrg_balances">
            <column name="tariff_id" type="bigint" defaultValue="${defaultTariffId}" />
        </addColumn>
    </changeSet>

    <changeSet id="add fk to nrg_balances to nrg_tariffs" author="oress">
        <addForeignKeyConstraint constraintName="fk_nrg_balances_tariff_id"
            baseTableName="nrg_balances"
            baseColumnNames="tariff_id"
            referencedTableName="nrg_tariffs"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="add index to nrg_balances for tariff_id" author="oress">
        <createIndex indexName="idx_nrg_balances_tariff_id" tableName="nrg_balances">
            <column name="tariff_id" />
        </createIndex>
    </changeSet>

    <changeSet id="extend nrg_orders with tariff_id" author="oress">
        <addColumn tableName="nrg_orders">
            <column name="tariff_id" type="bigint" defaultValue="${defaultTariffId}" />
        </addColumn>
    </changeSet>

    <changeSet id="add fk nrg_orders to nrg_tariffs" author="oress">
        <addForeignKeyConstraint constraintName="fk_nrg_orders_tariff_id"
            baseTableName="nrg_orders"
            baseColumnNames="tariff_id"
            referencedTableName="nrg_tariffs"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="add index to nrg_orders for tariff_id" author="oress">
        <createIndex indexName="idx_nrg_orders_tariff_id" tableName="nrg_orders">
            <column name="tariff_id" />
        </createIndex>
    </changeSet>

    <changeSet id="extend nrg_orders with tx_amount" author="oress">
        <addColumn tableName="nrg_orders">
            <column name="tx_amount" type="int" defaultValue="1" />
        </addColumn>
    </changeSet>

    <changeSet id="extend nrg_orders with chat_id, message_to_update" author="oress">
        <addColumn tableName="nrg_orders">
            <column name="chat_id" type="bigint" defaultValue="1" />
            <column name="message_to_update" type="bigint" defaultValue="1" />
        </addColumn>
    </changeSet>

    <changeSet id="add index idx_nrg_orders_serial" author="oress">
        <createIndex indexName="idx_nrg_orders_serial" tableName="nrg_orders">
            <column name="serial" />
        </createIndex>
    </changeSet>

    <changeSet id="add index idx_nrg_orders_created_at" author="oress">
        <createIndex indexName="idx_nrg_orders_created_at" tableName="nrg_orders">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="extend nrg_users with language_code" author="oress">
        <addColumn tableName="nrg_users">
            <column name="language_code" type="text" defaultValue="ru" />
        </addColumn>
    </changeSet>
</databaseChangeLog>